<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DialogueForge</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&family=Bebas+Neue&display=swap');

:root {
  --bg:     #0c0e13;
  --bg2:    #12151d;
  --bg3:    #181c27;
  --bg4:    #1e2233;
  --bg5:    #252a3c;
  --border: #272c3e;
  --border2:#32394f;
  --text:   #dde2f0;
  --text2:  #7d8aa0;
  --text3:  #48526a;
  --accent: #4d8fff;
  --red:    #f05c5c;
  --green:  #4ecb82;
  --yellow: #f0c94d;
  --purple: #a06af0;
  --teal:   #4dcbcb;
  --orange: #f0934d;
  --shadow: 0 6px 28px rgba(0,0,0,0.55);
}

*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;font-size:13px;}

/* TOPBAR */
#topbar{height:46px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:8px;flex-shrink:0;z-index:100;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--accent);text-shadow:0 0 18px rgba(77,143,255,.35);margin-right:4px;flex-shrink:0;}
.logo em{color:var(--red);font-style:normal;}
.sep-v{width:1px;height:22px;background:var(--border2);flex-shrink:0;}
#proj-name{background:transparent;border:none;border-bottom:1px solid transparent;color:var(--text);font-family:'Noto Sans KR',sans-serif;font-size:13px;outline:none;padding:2px 4px;width:170px;transition:border-color .2s;}
#proj-name:focus{border-bottom-color:var(--accent);}
.spacer{flex:1;}
.btn{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:5px;border:1px solid var(--border2);background:var(--bg3);color:var(--text);cursor:pointer;font-size:12px;font-family:inherit;transition:all .15s;white-space:nowrap;flex-shrink:0;}
.btn:hover{background:var(--bg4);border-color:var(--accent);color:var(--accent);}
.btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.btn.primary:hover{background:#3a7ae8;}
.btn:disabled{opacity:.4;cursor:default;pointer-events:none;}
.btn svg{width:13px;height:13px;flex-shrink:0;}

/* MAIN */
#main{display:flex;flex:1;overflow:hidden;}

/* RESIZER */
.resizer{width:5px;background:var(--border);flex-shrink:0;cursor:col-resize;transition:background .15s;z-index:10;}
.resizer:hover,.resizer.dragging{background:var(--accent);}

/* SIDEBAR */
#sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.sb-title{padding:10px 12px 6px;font-size:9px;font-weight:700;letter-spacing:2px;color:var(--text3);text-transform:uppercase;}
.palette{display:grid;grid-template-columns:1fr 1fr;gap:5px;padding:0 10px 10px;}
.pal{padding:8px 4px 7px;border-radius:5px;border:1px solid;cursor:pointer;text-align:center;font-size:10px;font-weight:600;transition:all .15s;user-select:none;letter-spacing:.3px;}
.pal:hover{opacity:.8;transform:translateY(-1px);}
.pal .pi{font-size:14px;display:block;margin-bottom:3px;}
.pal-root     {background:#141e14;border-color:#2a5a2a;color:#4ecb82;}
.pal-dialog   {background:#141e2e;border-color:#2a4a7a;color:#6aacff;}
.pal-choice   {background:#141e20;border-color:#1e5c2e;color:#4ecb82;}
.pal-condition{background:#201a2e;border-color:#5c2a7a;color:#c07cf5;}
.pal-flag     {background:#1e1a10;border-color:#7a6010;color:#f0c94d;}
.pal-hub      {background:#0f1e20;border-color:#1a5c5c;color:#4dcbcb;}
.pal-loop     {background:#1a1820;border-color:#4a3a70;color:#a06af0;}
.pal-leaf     {background:#201414;border-color:#7a2a2a;color:#f07070;}

.sb-divider{height:1px;background:var(--border);margin:0 10px;}

/* SEARCH */
#search-wrap{padding:8px 10px;display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border);}
#search-input{flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:5px;color:var(--text);font-size:11px;font-family:inherit;padding:5px 8px;outline:none;transition:border-color .15s;}
#search-input:focus{border-color:var(--accent);}
#search-clear{width:18px;height:18px;border-radius:3px;border:none;background:transparent;color:var(--text3);cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
#search-clear:hover{color:var(--text);}

#node-list{flex:1;overflow-y:auto;padding:6px;}
.nli{padding:6px 8px;border-radius:4px;cursor:pointer;display:flex;align-items:center;gap:7px;font-size:11px;transition:background .1s;border:1px solid transparent;}
.nli:hover{background:var(--bg3);}
.nli.sel{background:var(--bg4);border-color:var(--accent);}
.nli.multi-sel{background:var(--bg4);border-color:var(--orange);}
.nli-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.nli-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.nli-id{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);}
.nli-group{font-size:9px;color:var(--orange);font-family:'JetBrains Mono',monospace;flex-shrink:0;}

/* GROUP ITEMS IN LIST */
.nli-group-header{padding:5px 8px 3px;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--orange);display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;}
.nli-group-header:hover{color:var(--text);}
.nli-group-header .gh-arrow{font-size:8px;transition:transform .15s;display:inline-block;}
.nli-group-header .gh-arrow.open{transform:rotate(90deg);}

/* CANVAS */
#canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--bg);background-image:radial-gradient(var(--border) 1px,transparent 1px);background-size:26px 26px;}
#canvas{position:absolute;top:0;left:0;width:0;height:0;transform-origin:0 0;}
#canvas svg{position:absolute;top:0;left:0;width:8000px;height:8000px;pointer-events:none;overflow:visible;}

/* float toolbar */
#float-tb{position:absolute;top:12px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border2);border-radius:8px;padding:4px;display:flex;gap:2px;z-index:20;box-shadow:var(--shadow);}
.ftb{padding:5px 10px;border-radius:5px;border:none;background:transparent;color:var(--text2);font-size:11px;font-family:inherit;cursor:pointer;transition:all .15s;white-space:nowrap;}
.ftb:hover{background:var(--bg4);color:var(--text);}
.ftb-sep{width:1px;background:var(--border);margin:4px 2px;}

/* zoom */
#zoom-bar{position:absolute;bottom:12px;left:12px;display:flex;gap:4px;z-index:20;}
.zbtn{width:28px;height:28px;border-radius:5px;border:1px solid var(--border2);background:var(--bg2);color:var(--text2);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.zbtn:hover{background:var(--bg3);color:var(--text);}
#zoom-label{height:28px;padding:0 9px;border-radius:5px;border:1px solid var(--border2);background:var(--bg2);color:var(--text3);font-size:10px;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;}

/* minimap */
#minimap-wrap{position:absolute;bottom:12px;right:12px;background:var(--bg2);border:1px solid var(--border2);border-radius:6px;overflow:hidden;z-index:20;}

/* MULTI-SELECT RUBBER BAND */
#rubber-band{position:absolute;border:1px solid var(--orange);background:rgba(240,147,77,.07);pointer-events:none;display:none;z-index:5;}

/* MULTI-SELECT ACTION BAR */
#multi-bar{position:absolute;top:12px;right:12px;background:var(--bg2);border:1px solid var(--orange);border-radius:8px;padding:5px 8px;display:none;gap:6px;z-index:25;box-shadow:var(--shadow);align-items:center;}
#multi-bar.show{display:flex;}
#multi-bar .mb-count{font-size:11px;color:var(--orange);font-family:'JetBrains Mono',monospace;padding:0 4px;}
.mb-btn{padding:4px 10px;border-radius:4px;border:1px solid var(--border2);background:var(--bg3);color:var(--text2);font-size:11px;cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;}
.mb-btn:hover{background:var(--bg4);color:var(--text);}
.mb-btn.danger{border-color:var(--red);color:var(--red);}
.mb-btn.danger:hover{background:rgba(240,92,92,.1);}

/* NODE CARDS */
.node-card{position:absolute;width:230px;border-radius:8px;border:1px solid;box-shadow:var(--shadow);cursor:default;user-select:none;transition:box-shadow .15s;}
.node-card:hover{box-shadow:0 0 0 1px var(--accent),var(--shadow);}
.node-card.sel{box-shadow:0 0 0 2px var(--accent),var(--shadow);}
.node-card.multi-sel{box-shadow:0 0 0 2px var(--orange),var(--shadow);}
.node-card.search-match{box-shadow:0 0 0 2px var(--yellow),var(--shadow);}
.nc-root     {background:#0e1c0e;border-color:#224822;}
.nc-dialog   {background:#101b2c;border-color:#253d6a;}
.nc-choice   {background:#101c12;border-color:#1e4e28;}
.nc-condition{background:#1c1228;border-color:#4a2268;}
.nc-flag     {background:#1c1a08;border-color:#5c4a08;}
.nc-hub      {background:#081c1e;border-color:#145454;}
.nc-loop     {background:#161228;border-color:#3e2a68;}
.nc-leaf     {background:#1e1010;border-color:#6a2020;}
.node-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;border-radius:8px 0 0 8px;}
.nc-root::before     {background:#4ecb82;}
.nc-dialog::before   {background:#4d8fff;}
.nc-choice::before   {background:#4ecb82;}
.nc-condition::before{background:#a06af0;}
.nc-flag::before     {background:#f0c94d;}
.nc-hub::before      {background:#4dcbcb;}
.nc-loop::before     {background:#a06af0;}
.nc-leaf::before     {background:#f05c5c;}

.nc-header{padding:7px 10px 7px 14px;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,255,255,.055);}
.nc-badge{font-size:9px;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:3px;font-weight:600;letter-spacing:.5px;flex-shrink:0;}
.b-root     {background:rgba(78,203,130,.15);color:#4ecb82;}
.b-dialog   {background:rgba(77,143,255,.15);color:#4d8fff;}
.b-choice   {background:rgba(78,203,130,.15);color:#4ecb82;}
.b-condition{background:rgba(160,106,240,.15);color:#a06af0;}
.b-flag     {background:rgba(240,201,77,.15);color:#f0c94d;}
.b-hub      {background:rgba(77,203,203,.15);color:#4dcbcb;}
.b-loop     {background:rgba(160,106,240,.15);color:#a06af0;}
.b-leaf     {background:rgba(240,92,92,.15);color:#f05c5c;}

.nc-speaker{font-size:12px;font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.nc-id{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3);}
.nc-body{padding:8px 10px 8px 14px;font-size:11px;color:var(--text2);line-height:1.55;display:-webkit-box;line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;position:relative;}
.nc-footer{padding:5px 10px 6px 14px;display:flex;flex-wrap:wrap;gap:4px;border-top:1px solid rgba(255,255,255,.04);}
.nc-tag{font-size:9px;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:3px;background:rgba(255,255,255,.06);color:var(--text3);}
.nc-group-tag{font-size:9px;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:3px;background:rgba(240,147,77,.12);color:var(--orange);}

/* GROUP FRAME on canvas */
.group-frame{position:absolute;border-radius:10px;border:2px dashed;pointer-events:none;z-index:0;}

/* ports */
.port{position:absolute;width:11px;height:11px;border-radius:50%;border:2px solid var(--bg);cursor:crosshair;transition:transform .15s,background .15s;}
.port-out{bottom:-6px;left:50%;margin-left:-5px;background:var(--border2);}
.port-out:hover{transform:scale(1.4);background:var(--accent);}
.port-in{top:-6px;left:50%;margin-left:-5px;background:var(--border2);}
.port-in:hover{transform:scale(1.4);background:var(--green);}

.nc-drag{cursor:grab;position:absolute;inset:0;border-radius:8px;z-index:0;}
.nc-drag:active{cursor:grabbing;}
.nc-header,.nc-body,.nc-footer,.port{position:relative;z-index:1;}
.port{position:absolute;z-index:2;}

/* INSPECTOR */
#inspector{width:380px;background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
#insp-top{padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:8px;}
#insp-title{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);flex:1;}
#insp-body{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px;}

.field{display:flex;flex-direction:column;gap:5px;}
.flabel{font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text3);}
.finput,.ftextarea,.fselect{background:var(--bg3);border:1px solid var(--border2);border-radius:5px;color:var(--text);font-size:12px;font-family:'Noto Sans KR',sans-serif;padding:7px 9px;outline:none;transition:border-color .15s;width:100%;}
.finput:focus,.ftextarea:focus,.fselect:focus{border-color:var(--accent);}
.ftextarea{resize:vertical;min-height:80px;line-height:1.6;}
.fselect option{background:var(--bg3);}

/* addon (conditions / flags / sounds) */
.addon{border:1px solid var(--border);border-radius:7px;overflow:visible;}
.addon-head{padding:10px 14px;background:var(--bg3);display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;transition:background .15s;border-radius:7px 7px 0 0;}
.addon-head:hover{background:var(--bg4);}
.addon-head.closed{border-radius:7px;}
.ah-label{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text2);flex:1;}
.ah-count{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--text3);}
.ah-arrow{font-size:9px;color:var(--text3);transition:transform .2s;display:inline-block;}
.ah-arrow.open{transform:rotate(90deg);}
.addon-body{padding:10px;display:flex;flex-direction:column;gap:6px;border-top:1px solid var(--border);border-radius:0 0 7px 7px;overflow-y:auto;}
.addon-body.hidden{display:none;}

.crow,.frow{display:flex;align-items:center;gap:6px;background:var(--bg4);border-radius:5px;padding:7px 9px;}
.crow input,.frow input{background:transparent;border:none;color:var(--text);font-size:12px;font-family:'JetBrains Mono',monospace;outline:none;flex:1;min-width:0;}
.c-op{background:var(--bg5);border:none;color:var(--text2);font-size:11px;font-family:'JetBrains Mono',monospace;border-radius:3px;padding:2px 5px;cursor:pointer;flex-shrink:0;}
.toggle{width:32px;height:18px;border-radius:9px;background:var(--bg5);position:relative;cursor:pointer;border:1px solid var(--border2);flex-shrink:0;transition:background .2s;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:#fff;transition:left .2s;}
.toggle.on::after{left:16px;}
.ic-btn{width:22px;height:22px;border-radius:4px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
.ic-btn:hover{background:var(--bg5);color:var(--red);}
.ic-btn svg{width:11px;height:11px;}
.add-btn{display:flex;align-items:center;gap:5px;padding:5px 8px;border-radius:4px;border:1px dashed var(--border2);background:transparent;color:var(--text3);font-size:11px;cursor:pointer;width:100%;font-family:inherit;transition:all .15s;}
.add-btn:hover{border-color:var(--accent);color:var(--accent);}

.idivider{height:1px;background:var(--border);}
.insp-empty{color:var(--text3);font-size:12px;text-align:center;padding:48px 16px;line-height:1.8;}
.slider-row{display:flex;align-items:center;gap:8px;}
.slider-row input[type=range]{flex:1;accent-color:var(--accent);}
.sval{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);width:26px;text-align:right;}

/* TEXT EFFECT PREVIEW */
.fx-preview{background:var(--bg);border-radius:5px;padding:8px 10px;font-size:12px;line-height:1.7;min-height:36px;border:1px solid var(--border);word-break:break-word;}
.fx-tag-hint{font-size:9px;color:var(--text3);line-height:1.8;font-family:'JetBrains Mono',monospace;}

/* SOUND ROW */
.srow{display:flex;align-items:center;gap:6px;background:var(--bg4);border-radius:5px;padding:7px 9px;}
.srow input{background:transparent;border:none;color:var(--text);font-size:12px;font-family:'JetBrains Mono',monospace;outline:none;flex:1;min-width:0;}
.s-type{background:var(--bg5);border:none;color:var(--text2);font-size:10px;font-family:'JetBrains Mono',monospace;border-radius:3px;padding:2px 4px;cursor:pointer;flex-shrink:0;}

/* STATUS */
#statusbar{height:24px;background:var(--accent);display:flex;align-items:center;padding:0 14px;gap:18px;flex-shrink:0;}
.st{font-size:10px;font-family:'JetBrains Mono',monospace;color:rgba(255,255,255,.75);display:flex;align-items:center;gap:5px;}
.st span{color:#fff;font-weight:600;}

/* CTX MENU */
#ctx{position:fixed;background:var(--bg2);border:1px solid var(--border2);border-radius:7px;padding:5px;z-index:1000;min-width:158px;display:none;box-shadow:var(--shadow);}
#ctx.show{display:block;}
.ci{padding:6px 10px;border-radius:4px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--text);transition:background .1s;}
.ci:hover{background:var(--bg4);}
.ci.danger{color:var(--red);}
.ci svg{width:12px;height:12px;flex-shrink:0;}
.csep{height:1px;background:var(--border);margin:3px 0;}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:2000;display:none;align-items:center;justify-content:center;}
.overlay.show{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:10px;padding:22px;width:480px;max-width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.8);}
.modal h3{font-size:15px;margin-bottom:14px;}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px;}
.json-pre{font-family:'JetBrains Mono',monospace;font-size:10px;background:var(--bg);border-radius:6px;padding:14px;overflow-y:auto;max-height:360px;color:var(--green);white-space:pre;line-height:1.6;}

/* GROUP MODAL */
#group-modal .gcolor-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
.gcolor-swatch{width:24px;height:24px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
.gcolor-swatch.active{border-color:#fff;}

/* TOAST */
#toast{position:fixed;bottom:36px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:8px 18px;font-size:12px;box-shadow:var(--shadow);z-index:9999;opacity:0;pointer-events:none;transition:all .25s;white-space:nowrap;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
#toast.ok{border-color:var(--green);color:var(--green);}
#toast.err{border-color:var(--red);color:var(--red);}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>

<!-- TOPBAR -->
<div id="topbar">
  <div class="logo">Dialogue<em>Forge</em></div>
  <div class="sep-v"></div>
  <input id="proj-name" value="ìƒˆ í”„ë¡œì íŠ¸" placeholder="í”„ë¡œì íŠ¸ ì´ë¦„">
  <div class="spacer"></div>
  <!-- UNDO/REDO -->
  <button class="btn" id="btn-undo" onclick="undo()" title="ì‹¤í–‰ ì·¨ì†Œ (Ctrl+Z)">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 7 C3 4 6 2 9 2c3.3 0 6 2.7 6 6s-2.7 6-6 6H4"/><polyline points="6,4 3,7 6,10"/></svg>ì‹¤í–‰ ì·¨ì†Œ
  </button>
  <button class="btn" id="btn-redo" onclick="redo()" title="ë‹¤ì‹œ ì‹¤í–‰ (Ctrl+Y)">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M13 7 C13 4 10 2 7 2c-3.3 0-6 2.7-6 6s2.7 6 6 6h5"/><polyline points="10,4 13,7 10,10"/></svg>ë‹¤ì‹œ ì‹¤í–‰
  </button>
  <div class="sep-v"></div>
  <button class="btn" onclick="autoLayout()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4h12M2 8h8M2 12h5"/></svg>ìë™ ì •ë ¬
  </button>
  <button class="btn" onclick="showJson()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 2h8l3 3v9H2V2h2"/><path d="M9 2v4H5V2"/></svg>JSON
  </button>
  <button class="btn" onclick="saveJSON()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 2h7l3 3v9H3V2z"/><path d="M9 2v4H6V2"/><line x1="5" y1="11" x2="11" y2="11"/></svg>ì €ì¥
  </button>
  <button class="btn primary" onclick="document.getElementById('file-in').click()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 2v8M5 7l3 3 3-3M2 13h12"/></svg>ë¶ˆëŸ¬ì˜¤ê¸°
  </button>
  <input type="file" id="file-in" accept=".json" style="display:none" onchange="loadJSON(event)">
</div>

<!-- MAIN -->
<div id="main">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sb-title">ë…¸ë“œ íŒ”ë ˆíŠ¸</div>
    <div class="palette">
      <div class="pal pal-root"      draggable="true" ondragstart="palDrag(event,'root')"      onclick="addNode('root')"><span class="pi">â—</span>ë£¨íŠ¸</div>
      <div class="pal pal-dialog"    draggable="true" ondragstart="palDrag(event,'dialog')"    onclick="addNode('dialog')"><span class="pi">ğŸ’¬</span>ëŒ€ì‚¬</div>
      <div class="pal pal-choice"    draggable="true" ondragstart="palDrag(event,'choice')"    onclick="addNode('choice')"><span class="pi">â˜°</span>ì„ íƒì§€</div>
      <div class="pal pal-condition" draggable="true" ondragstart="palDrag(event,'condition')" onclick="addNode('condition')"><span class="pi">â—‡</span>ì¡°ê±´</div>
      <div class="pal pal-flag"      draggable="true" ondragstart="palDrag(event,'flag')"      onclick="addNode('flag')"><span class="pi">âš‘</span>í”Œë˜ê·¸</div>
      <div class="pal pal-hub"       draggable="true" ondragstart="palDrag(event,'hub')"       onclick="addNode('hub')"><span class="pi">âŠ•</span>í—ˆë¸Œ</div>
      <div class="pal pal-loop"      draggable="true" ondragstart="palDrag(event,'loop')"      onclick="addNode('loop')"><span class="pi">â†º</span>ë£¨í”„</div>
      <div class="pal pal-leaf"      draggable="true" ondragstart="palDrag(event,'leaf')"      onclick="addNode('leaf')"><span class="pi">âœ•</span>ì—”ë”©</div>
    </div>
    <div class="sb-divider"></div>

    <!-- SEARCH -->
    <div id="search-wrap">
      <input id="search-input" placeholder="ğŸ” ë…¸ë“œ ê²€ìƒ‰â€¦" oninput="onSearch(this.value)">
      <button id="search-clear" onclick="clearSearch()" title="ê²€ìƒ‰ ì´ˆê¸°í™”">âœ•</button>
    </div>

    <div class="sb-title" style="padding-top:8px">ë…¸ë“œ ëª©ë¡</div>
    <div id="node-list"></div>
  </div>

  <!-- SIDEBAR RESIZER -->
  <div class="resizer" id="sidebar-resizer"></div>

  <!-- CANVAS -->
  <div id="canvas-wrap" ondragover="event.preventDefault()" ondrop="canvasDrop(event)" oncontextmenu="canvasCtx(event)">
    <div id="canvas"><svg id="esvg"></svg></div>
    <div id="rubber-band"></div>

    <div id="float-tb">
      <button class="ftb" onclick="addNode('root')">â— ë£¨íŠ¸</button>
      <button class="ftb" onclick="addNode('dialog')">ğŸ’¬ ëŒ€ì‚¬</button>
      <button class="ftb" onclick="addNode('choice')">â˜° ì„ íƒì§€</button>
      <div class="ftb-sep"></div>
      <button class="ftb" onclick="addNode('condition')">â—‡ ì¡°ê±´</button>
      <button class="ftb" onclick="addNode('flag')">âš‘ í”Œë˜ê·¸</button>
      <button class="ftb" onclick="addNode('hub')">âŠ• í—ˆë¸Œ</button>
      <button class="ftb" onclick="addNode('loop')">â†º ë£¨í”„</button>
      <button class="ftb" onclick="addNode('leaf')">âœ• ì—”ë”©</button>
    </div>

    <!-- MULTI SELECT ACTION BAR -->
    <div id="multi-bar">
      <span class="mb-count" id="mb-count">0ê°œ ì„ íƒ</span>
      <button class="mb-btn" onclick="groupSelected()">â–£ ê·¸ë£¹ ìƒì„±</button>
      <button class="mb-btn" onclick="duplicateSelected()">ë³µì œ</button>
      <button class="mb-btn danger" onclick="deleteSelected()">ì‚­ì œ</button>
      <button class="mb-btn" onclick="clearMultiSel()">âœ•</button>
    </div>

    <div id="zoom-bar">
      <button class="zbtn" onclick="doZoom(1.2)">+</button>
      <div id="zoom-label">100%</div>
      <button class="zbtn" onclick="doZoom(0.8)">âˆ’</button>
      <button class="zbtn" onclick="resetView()" style="font-size:11px">âŠ¡</button>
    </div>

    <div id="minimap-wrap"><canvas id="minimap" width="150" height="90"></canvas></div>
  </div>

  <!-- INSPECTOR RESIZER -->
  <div class="resizer" id="inspector-resizer"></div>

  <!-- INSPECTOR -->
  <div id="inspector">
    <div id="insp-top">
      <div id="insp-title">ì¸ìŠ¤í™í„°</div>
      <button class="ic-btn" style="width:26px;height:26px" onclick="deleteSelected()" title="ì‚­ì œ">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 4h10M6 4V2h4v2M5 4v8h6V4"/></svg>
      </button>
    </div>
    <div id="insp-body"><div class="insp-empty">ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì„œ í¸ì§‘í•©ë‹ˆë‹¤</div></div>
  </div>
</div>

<!-- STATUS -->
<div id="statusbar">
  <div class="st">ë…¸ë“œ <span id="st-n">0</span></div>
  <div class="st">ì—°ê²° <span id="st-e">0</span></div>
  <div class="st">ì„ íƒ <span id="st-s">â€”</span></div>
  <div class="st" id="st-hist" style="color:rgba(255,255,255,.5)"></div>
  <div class="st" style="margin-left:auto">DialogueForge v3.0</div>
</div>

<!-- CTX MENU -->
<div id="ctx">
  <div class="ci" id="ci-child" onclick="ctxChild()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="12" height="12" rx="2"/><line x1="8" y1="5" x2="8" y2="11"/><line x1="5" y1="8" x2="11" y2="8"/></svg>ìì‹ ë…¸ë“œ ì¶”ê°€
  </div>
  <div class="ci" id="ci-conn" onclick="startConnect()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 8h4M10 8h4M6 5l4 3-4 3"/></svg>ì—°ê²° ì‹œì‘
  </div>
  <div class="csep"></div>
  <div class="ci" onclick="duplicateSelected()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="5" y="5" width="8" height="8" rx="1"/><path d="M3 11V3h8"/></svg>ë³µì œ
  </div>
  <div class="ci" id="ci-group" onclick="groupSelected()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="14" height="14" rx="2" stroke-dasharray="3,2"/></svg>ê·¸ë£¹ ìƒì„±
  </div>
  <div class="ci" id="ci-ungroup" onclick="ungroupSelected()" style="display:none">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="14" height="14" rx="2" stroke-dasharray="3,2"/><line x1="4" y1="8" x2="12" y2="8"/></svg>ê·¸ë£¹ í•´ì œ
  </div>
  <div class="csep"></div>
  <div class="ci danger" onclick="deleteSelected()">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 4h10M6 4V2h4v2M5 4v8h6V4"/></svg>ì‚­ì œ
  </div>
</div>

<!-- JSON MODAL -->
<div class="overlay" id="json-modal">
  <div class="modal" style="width:580px">
    <h3>JSON ë¯¸ë¦¬ë³´ê¸°</h3>
    <div class="json-pre" id="json-pre"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('json-modal')">ë‹«ê¸°</button>
      <button class="btn primary" onclick="saveJSON()">ì €ì¥ (.json)</button>
    </div>
  </div>
</div>

<!-- GROUP MODAL -->
<div class="overlay" id="group-modal">
  <div class="modal" style="width:380px">
    <h3>ê·¸ë£¹ ë§Œë“¤ê¸°</h3>
    <div class="field" style="margin-bottom:12px">
      <div class="flabel">ê·¸ë£¹ ì´ë¦„</div>
      <input class="finput" id="group-name-input" placeholder="ì˜ˆ: 1ì¥ - ë§ˆì„" value="">
    </div>
    <div class="field">
      <div class="flabel">ìƒ‰ìƒ</div>
      <div class="gcolor-row" id="gcolor-row"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('group-modal')">ì·¨ì†Œ</button>
      <button class="btn primary" onclick="confirmGroup()">ê·¸ë£¹ ìƒì„±</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let nodes = [];
let edges = [];
let groups = [];   // {id, name, color, nodeIds[], collapsed}
let selId  = null;
let multiSel = new Set(); // multi-selected node ids
let nxtId  = 1;
let vp = {x:60,y:60,s:1};

let connecting   = null;
let connPrev     = null;
let dragging     = null;   // {id, ox, oy}  OR  {multi:true, starts:{id:{x,y}}, ox, oy}
let panning      = null;
let palType      = null;
let rubberBand   = null;   // {sx,sy,ex,ey} screen coords
let searchQuery  = '';

// â”€â”€â”€ UNDO / REDO â”€â”€â”€
const HIST_MAX = 80;
let history = [];
let histIdx  = -1;

function snapshot(){
  const s = JSON.stringify({nodes,edges,groups});
  // trim forward
  if(histIdx < history.length-1) history = history.slice(0,histIdx+1);
  history.push(s);
  if(history.length > HIST_MAX) history.shift();
  histIdx = history.length-1;
  updateUndoUI();
}
function undo(){
  if(histIdx<=0)return;
  histIdx--;
  restoreSnap(history[histIdx]);
  toast('ì‹¤í–‰ ì·¨ì†Œ','');
}
function redo(){
  if(histIdx>=history.length-1)return;
  histIdx++;
  restoreSnap(history[histIdx]);
  toast('ë‹¤ì‹œ ì‹¤í–‰','');
}
function restoreSnap(s){
  const d=JSON.parse(s);
  nodes=d.nodes;edges=d.edges;groups=d.groups||[];
  selId=null;multiSel.clear();
  renderAll();renderInsp();updateUndoUI();
}
function updateUndoUI(){
  document.getElementById('btn-undo').disabled = histIdx<=0;
  document.getElementById('btn-redo').disabled = histIdx>=history.length-1;
  document.getElementById('st-hist').textContent = `íˆìŠ¤í† ë¦¬ ${histIdx+1}/${history.length}`;
}

const TM = {
  root:      {label:'ë£¨íŠ¸',    col:'#4ecb82'},
  dialog:    {label:'ëŒ€ì‚¬',    col:'#4d8fff'},
  choice:    {label:'ì„ íƒì§€',  col:'#4ecb82'},
  condition: {label:'ì¡°ê±´',    col:'#a06af0'},
  flag:      {label:'í”Œë˜ê·¸',  col:'#f0c94d'},
  hub:       {label:'í—ˆë¸Œ',    col:'#4dcbcb'},
  loop:      {label:'ë£¨í”„',    col:'#a06af0'},
  leaf:      {label:'ì—”ë”©',    col:'#f05c5c'},
};

const GROUP_COLORS = ['#f0934d','#4d8fff','#4ecb82','#a06af0','#f0c94d','#f05c5c','#4dcbcb','#e879a0'];
let pendingGroupColor = GROUP_COLORS[0];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FACTORY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkNode(type,x,y){
  return {id:'N'+(nxtId++),type,x:Math.round(x),y:Math.round(y),
    speaker:'',text:'',
    portrait:'',textSpeed:30,
    conditions:[],flags:[],sounds:[],
    note:'',loopTarget:''};
}

function addNode(type){
  const w=document.getElementById('canvas-wrap').getBoundingClientRect();
  const x=(-vp.x+w.width/2)/vp.s-115, y=(-vp.y+w.height/2)/vp.s-60;
  const nd=mkNode(type,x,y); nodes.push(nd);
  snapshot(); renderAll(); selectNode(nd.id);
  toast('ë…¸ë“œ ì¶”ê°€: '+TM[type].label,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TEXT EFFECT RENDERER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTextEffectPreview(text){
  if(!text) return '<span style="color:var(--text3)">ë‚´ìš© ì—†ìŒ</span>';
  let out = h(text);
  out = out.replace(/\[color=([^\]]+)\](.*?)\[\/color\]/gi, (_,col,txt)=>
    `<span style="color:${col.replace(/[<>"']/g,'')}">${txt}</span>`);
  out = out.replace(/\[size=(\d+)\](.*?)\[\/size\]/gi, (_,sz,txt)=>
    `<span style="color:var(--text3)">[size=${sz}]</span>${txt}<span style="color:var(--text3)">[/size]</span>`);
  out = out.replace(/\[shake=(\d+)\](.*?)\[\/shake\]/gi, (_,s,txt)=>
    `<span style="color:var(--text3)">[shake=${s}]</span>${txt}<span style="color:var(--text3)">[/shake]</span>`);
  return out;
}
function updateFxPreview(val){const box=document.getElementById('fx-preview-box');if(box)box.innerHTML=renderTextEffectPreview(val);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RENDER ALL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  applyVP(); renderGroups(); renderNodes(); renderEdges(); renderList(); renderMinimap(); updateSt();
}
function applyVP(){
  document.getElementById('canvas').style.transform=`translate(${vp.x}px,${vp.y}px) scale(${vp.s})`;
  document.getElementById('zoom-label').textContent=Math.round(vp.s*100)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GROUPS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getGroupOf(nodeId){ return groups.find(g=>g.nodeIds.includes(nodeId)); }

function renderGroups(){
  const canvas=document.getElementById('canvas');
  canvas.querySelectorAll('.group-frame').forEach(e=>e.remove());
  groups.forEach(g=>{
    const members=nodes.filter(n=>g.nodeIds.includes(n.id));
    if(!members.length)return;
    const pad=20;
    const minX=Math.min(...members.map(n=>n.x))-pad;
    const minY=Math.min(...members.map(n=>n.y))-pad-18;
    const maxX=Math.max(...members.map(n=>n.x+230))+pad;
    const maxY=Math.max(...members.map(n=>{
      const el=document.querySelector(`.node-card[data-id="${n.id}"]`);
      return n.y+(el?el.offsetHeight:120);
    }))+pad;
    const fr=document.createElement('div');
    fr.className='group-frame';
    fr.style.cssText=`left:${minX}px;top:${minY}px;width:${maxX-minX}px;height:${maxY-minY}px;border-color:${g.color};background:${g.color}0d;`;
    fr.innerHTML=`<div style="position:absolute;top:4px;left:10px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;color:${g.color};letter-spacing:.5px;pointer-events:auto;cursor:pointer;user-select:none;" ondblclick="renameGroup('${g.id}')" title="ë”ë¸”í´ë¦­ìœ¼ë¡œ ì´ë¦„ ë³€ê²½">${h(g.name)}</div>`;
    canvas.insertBefore(fr,canvas.firstChild);
  });
}

function groupSelected(){
  const ids = multiSel.size>1?[...multiSel]:(selId?[selId]:null);
  if(!ids||ids.length<1){toast('ê·¸ë£¹í•  ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”','err');return;}
  // init color swatches
  const row=document.getElementById('gcolor-row');
  row.innerHTML=GROUP_COLORS.map(c=>`<div class="gcolor-swatch${c===pendingGroupColor?' active':''}" style="background:${c}" onclick="pickGColor('${c}',this)"></div>`).join('');
  document.getElementById('group-name-input').value='ìƒˆ ê·¸ë£¹';
  openModal('group-modal');
}

function pickGColor(c,el){
  pendingGroupColor=c;
  document.querySelectorAll('.gcolor-swatch').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
}

function confirmGroup(){
  const ids = multiSel.size>1?[...multiSel]:(selId?[selId]:[]);
  if(!ids.length){closeModal('group-modal');return;}
  const name=document.getElementById('group-name-input').value||'ìƒˆ ê·¸ë£¹';
  // remove nodes from any existing group first
  groups.forEach(g=>{g.nodeIds=g.nodeIds.filter(id=>!ids.includes(id));});
  groups=groups.filter(g=>g.nodeIds.length>0);
  groups.push({id:'G'+(nxtId++),name,color:pendingGroupColor,nodeIds:[...ids]});
  snapshot(); renderAll(); closeModal('group-modal');
  toast('ê·¸ë£¹ ìƒì„±ë¨','ok');
}

function ungroupSelected(){
  const ids=multiSel.size>0?[...multiSel]:(selId?[selId]:[]);
  groups.forEach(g=>{g.nodeIds=g.nodeIds.filter(id=>!ids.includes(id));});
  groups=groups.filter(g=>g.nodeIds.length>0);
  snapshot(); renderAll(); toast('ê·¸ë£¹ í•´ì œë¨','ok');
}

function renameGroup(gid){
  const g=groups.find(x=>x.id===gid);if(!g)return;
  const n=prompt('ê·¸ë£¹ ì´ë¦„',g.name);
  if(n!==null){g.name=n;snapshot();renderGroups();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NODES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNodes(){
  const canvas=document.getElementById('canvas');
  const existing=new Map([...canvas.querySelectorAll('.node-card')].map(el=>[el.dataset.id,el]));
  const cur=new Set(nodes.map(n=>n.id));
  existing.forEach((el,id)=>{ if(!cur.has(id)) el.remove(); });
  nodes.forEach(nd=>{
    let el=existing.get(nd.id);
    if(!el){ el=document.createElement('div'); el.dataset.id=nd.id; canvas.appendChild(el); }
    syncCard(el,nd);
  });
}

function syncCard(el,nd){
  const isSel = nd.id===selId;
  const isMulti = multiSel.has(nd.id);
  const isMatch = searchQuery && nodeMatchesSearch(nd);
  el.className=`node-card nc-${nd.type}${isSel?' sel':''}${isMulti?' multi-sel':''}${isMatch?' search-match':''}`;
  el.style.left=nd.x+'px'; el.style.top=nd.y+'px';

  const hasCond=nd.conditions&&nd.conditions.length;
  const hasFlag=nd.flags&&nd.flags.length;
  const hasSound=nd.sounds&&nd.sounds.length;
  const grp=getGroupOf(nd.id);
  const foot=nd.portrait||(nd.textSpeed!==30)||hasCond||hasFlag||hasSound||grp;

  el.innerHTML=`
    <div class="nc-drag"></div>
    <div class="port port-in"  data-id="${nd.id}"></div>
    <div class="nc-header" style="position:relative;z-index:1">
      <span class="nc-badge b-${nd.type}">${TM[nd.type]?.label||nd.type}</span>
      <span class="nc-speaker">${nd.speaker?h(nd.speaker):'<span style="color:var(--text3);font-weight:400">í™”ì ì—†ìŒ</span>'}</span>
      <span class="nc-id">${nd.id}</span>
    </div>
    <div class="nc-body" style="position:relative;z-index:1">${nd.text?renderTextEffectPreview(nd.text):'<span style="color:var(--text3)">ë‚´ìš© ì—†ìŒ</span>'}</div>
    ${foot?`<div class="nc-footer" style="position:relative;z-index:1">
      ${nd.portrait?`<span class="nc-tag">ğŸ–¼ ${h(nd.portrait)}</span>`:''}
      ${nd.textSpeed!==30?`<span class="nc-tag">âš¡${nd.textSpeed}</span>`:''}
      ${hasCond?`<span class="nc-tag" style="color:var(--purple)">â—‡ ${nd.conditions.length}</span>`:''}
      ${hasFlag?`<span class="nc-tag" style="color:var(--yellow)">âš‘ ${nd.flags.length}</span>`:''}
      ${hasSound?`<span class="nc-tag" style="color:var(--teal)">â™ª ${nd.sounds.length}</span>`:''}
      ${grp?`<span class="nc-group-tag">â–£ ${h(grp.name)}</span>`:''}
    </div>`:''}
    <div class="port port-out" data-id="${nd.id}"></div>`;

  el.addEventListener('mousedown',e=>{
    if(e.target.closest('.port-out')||e.target.closest('.port-in'))return;
    if(e.shiftKey){ toggleMultiSel(nd.id,e); }
    else { nodeDragStart(e,nd.id); }
  });
  el.querySelector('.port-out').addEventListener('mousedown',e=>{e.stopPropagation();startConnect(nd.id);});
  el.querySelector('.port-in').addEventListener('mousedown',e=>{e.stopPropagation();if(connecting&&connecting!==nd.id)finishConnect(nd.id);});
  el.addEventListener('click',e=>{
    if(e.target.closest('.port-in')||e.target.closest('.port-out'))return;
    if(connecting){if(connecting!==nd.id)finishConnect(nd.id);return;}
    if(e.shiftKey)return; // handled in mousedown
    selectNode(nd.id);
  });
  el.addEventListener('contextmenu',e=>{
    e.preventDefault();
    if(!multiSel.has(nd.id)){selectNode(nd.id);}
    const inGrp=!!getGroupOf(nd.id)||(multiSel.size>0&&[...multiSel].some(id=>getGroupOf(id)));
    document.getElementById('ci-ungroup').style.display=inGrp?'':'none';
    document.getElementById('ci-group').style.display='';
    showCtx(e.clientX,e.clientY,true);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MULTI SELECT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleMultiSel(id,e){
  e && e.stopPropagation();
  if(multiSel.has(id)){multiSel.delete(id);}
  else{multiSel.add(id); selId=null;}
  updateMultiBar(); renderNodes(); renderList();
}
function clearMultiSel(){multiSel.clear();updateMultiBar();renderNodes();renderList();}
function updateMultiBar(){
  const bar=document.getElementById('multi-bar');
  const cnt=multiSel.size;
  if(cnt>1){bar.classList.add('show');document.getElementById('mb-count').textContent=cnt+'ê°œ ì„ íƒ';}
  else{bar.classList.remove('show');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nodeMatchesSearch(nd){
  if(!searchQuery)return false;
  const q=searchQuery.toLowerCase();
  return (nd.speaker||'').toLowerCase().includes(q)
      ||(nd.text||'').toLowerCase().includes(q)
      ||(nd.id||'').toLowerCase().includes(q)
      ||(nd.note||'').toLowerCase().includes(q)
      ||(TM[nd.type]?.label||'').toLowerCase().includes(q);
}
function onSearch(val){
  searchQuery=val.trim();
  renderNodes();renderList();
  if(searchQuery){
    const matches=nodes.filter(nodeMatchesSearch);
    if(matches.length)scrollToNode(matches[0].id);
  }
}
function clearSearch(){
  searchQuery='';
  document.getElementById('search-input').value='';
  renderNodes();renderList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EDGES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEdges(){
  const svg=document.getElementById('esvg');
  svg.innerHTML='';
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  Object.entries(TM).forEach(([t,m])=>{
    const mk=document.createElementNS('http://www.w3.org/2000/svg','marker');
    mk.setAttribute('id','a-'+t);mk.setAttribute('markerWidth','8');mk.setAttribute('markerHeight','8');
    mk.setAttribute('refX','7');mk.setAttribute('refY','3');mk.setAttribute('orient','auto');
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('d','M0,0 L0,6 L8,3 z');p.setAttribute('fill',m.col);
    mk.appendChild(p);defs.appendChild(mk);
  });
  svg.appendChild(defs);

  edges.forEach(ed=>{
    const fn=nodes.find(n=>n.id===ed.from),tn=nodes.find(n=>n.id===ed.to); if(!fn||!tn) return;
    const fe=document.querySelector(`.node-card[data-id="${fn.id}"]`),te=document.querySelector(`.node-card[data-id="${tn.id}"]`);
    if(!fe||!te) return;
    const fx=fn.x+fe.offsetWidth/2,fy=fn.y+fe.offsetHeight;
    const tx2=tn.x+te.offsetWidth/2,ty2=tn.y;
    const cy=Math.max(Math.abs(ty2-fy)*.5,50);
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${fx},${fy} C${fx},${fy+cy} ${tx2},${ty2-cy} ${tx2},${ty2}`);
    path.setAttribute('fill','none');path.setAttribute('stroke',TM[fn.type]?.col||'#555');
    path.setAttribute('stroke-width','1.8');path.setAttribute('marker-end',`url(#a-${fn.type})`);
    path.setAttribute('opacity','0.65');path.style.pointerEvents='stroke';path.style.cursor='pointer';
    path.addEventListener('contextmenu',e=>{e.preventDefault();if(confirm('ì´ ì—°ê²°ì„ ì‚­ì œí• ê¹Œìš”?')){edges=edges.filter(x=>x!==ed);snapshot();renderAll();}});
    if(ed.label){
      const t2=document.createElementNS('http://www.w3.org/2000/svg','text');
      t2.setAttribute('x',(fx+tx2)/2);t2.setAttribute('y',(fy+ty2)/2-4);
      t2.setAttribute('text-anchor','middle');t2.setAttribute('fill','#48526a');
      t2.setAttribute('font-size','10');t2.setAttribute('font-family','JetBrains Mono');
      t2.textContent=ed.label;svg.appendChild(t2);
    }
    svg.appendChild(path);
  });

  if(connecting&&connPrev){
    const fn=nodes.find(n=>n.id===connecting),fe=document.querySelector(`.node-card[data-id="${connecting}"]`);
    if(fn&&fe){
      const fx=fn.x+fe.offsetWidth/2,fy=fn.y+fe.offsetHeight;
      const cy=Math.max(Math.abs(connPrev.y-fy)*.5,50);
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d',`M${fx},${fy} C${fx},${fy+cy} ${connPrev.x},${connPrev.y-cy} ${connPrev.x},${connPrev.y}`);
      path.setAttribute('fill','none');path.setAttribute('stroke','#4d8fff');
      path.setAttribute('stroke-width','1.5');path.setAttribute('stroke-dasharray','6,4');
      svg.appendChild(path);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SELECT / INSPECTOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectNode(id){
  selId=id; multiSel.clear(); updateMultiBar(); renderAll(); renderInsp();
}

function renderInsp(){
  const body=document.getElementById('insp-body');
  const title=document.getElementById('insp-title');

  // multi-select inspector
  if(multiSel.size>1){
    title.textContent=`${multiSel.size}ê°œ ë…¸ë“œ ì„ íƒ`;
    const grp=groups.find(g=>[...multiSel].every(id=>g.nodeIds.includes(id)));
    body.innerHTML=`<div class="insp-empty" style="padding:24px 16px">
      <div style="font-size:28px;margin-bottom:12px">â–£</div>
      <div style="color:var(--orange);font-weight:700;margin-bottom:8px">${multiSel.size}ê°œ ë…¸ë“œ ì„ íƒë¨</div>
      <div style="font-size:11px;line-height:1.9;color:var(--text3)">
        Shift+í´ë¦­ìœ¼ë¡œ ì¶”ê°€ ì„ íƒ<br>Shift+ë“œë˜ê·¸ë¡œ ë²”ìœ„ ì„ íƒ<br>ë…¸ë“œ ë“œë˜ê·¸ë¡œ ì¼ê´„ ì´ë™<br>ìƒë‹¨ ë°”ì—ì„œ ê·¸ë£¹/ë³µì œ/ì‚­ì œ
      </div>
      ${grp?`<div style="margin-top:12px;font-size:11px;color:var(--orange)">ê·¸ë£¹: ${h(grp.name)}</div>`:''}
    </div>`;
    return;
  }

  if(!selId){title.textContent='ì¸ìŠ¤í™í„°';body.innerHTML='<div class="insp-empty">ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì„œ í¸ì§‘í•©ë‹ˆë‹¤</div>';return;}
  const nd=nodes.find(n=>n.id===selId); if(!nd) return;
  title.textContent=`[${TM[nd.type]?.label}] ${nd.id}`;
  const cc=nd.conditions.length, fc=nd.flags.length, sc=(nd.sounds||[]).length;
  const grpOfNode=getGroupOf(nd.id);

  body.innerHTML=`
    <!-- íƒ€ì… -->
    <div class="field">
      <div class="flabel">ë…¸ë“œ íƒ€ì…</div>
      <select class="fselect" onchange="sf('type',this.value);snapshot();renderAll()">
        ${Object.entries(TM).map(([k,v])=>`<option value="${k}"${nd.type===k?' selected':''}>${v.label}</option>`).join('')}
      </select>
    </div>

    <!-- ê·¸ë£¹ -->
    <div class="field">
      <div class="flabel">ê·¸ë£¹</div>
      <select class="fselect" onchange="assignGroup(this.value)">
        <option value="">â€” ì—†ìŒ â€”</option>
        ${groups.map(g=>`<option value="${g.id}"${grpOfNode&&grpOfNode.id===g.id?' selected':''}>${h(g.name)}</option>`).join('')}
      </select>
    </div>

    <!-- í™”ì + ëŒ€ì‚¬ -->
    <div class="field">
      <div class="flabel">í™”ì</div>
      <input class="finput" value="${ha(nd.speaker)}" placeholder="ì˜ˆ: ë§ˆì„ ì¥ë¡œ" oninput="sf('speaker',this.value);rc()">
    </div>
    <div class="field">
      <div class="flabel">ëŒ€ì‚¬ ë‚´ìš© <span style="font-weight:400;color:var(--text3);font-size:9px;letter-spacing:0">â€” [color=#f00]í…ìŠ¤íŠ¸[/color] Â· [size=18]í…ìŠ¤íŠ¸[/size] Â· [shake=3]í…ìŠ¤íŠ¸[/shake]</span></div>
      <textarea class="ftextarea" placeholder="ëŒ€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" oninput="sf('text',this.value);rc();updateFxPreview(this.value)">${h(nd.text)}</textarea>
      <div class="fx-preview" id="fx-preview-box">${renderTextEffectPreview(nd.text)}</div>
    </div>

    <div class="idivider"></div>

    <!-- ì¡°ê±´ -->
    <div class="addon">
      <div class="addon-head${cc?'':' closed'}" onclick="toggleAddon(this)">
        <span class="ah-label" style="color:var(--purple)">â—‡ ì¡°ê±´ (Conditions)</span>
        <span class="ah-count" id="cc-lbl">${cc?cc+'ê°œ':'ì—†ìŒ'}</span>
        <span class="ah-arrow${cc?' open':''}">â–¶</span>
      </div>
      <div class="addon-body${cc?'':' hidden'}" id="cond-body">
        <div id="cond-list">${(nd.conditions||[]).map((c,i)=>`
          <div class="crow">
            <input value="${ha(c.key)}" placeholder="ë³€ìˆ˜ëª…" oninput="uc(${i},'key',this.value)">
            <select class="c-op" onchange="uc(${i},'op',this.value)">
              ${['==','!=','>','<','>=','<='].map(op=>`<option${c.op===op?' selected':''}>${op}</option>`).join('')}
            </select>
            <input value="${ha(c.value)}" placeholder="ê°’" style="max-width:58px" oninput="uc(${i},'value',this.value)">
            <button class="ic-btn" onclick="rc2(${i})"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="12" y2="12"/><line x1="12" y1="4" x2="4" y2="12"/></svg></button>
          </div>`).join('')}</div>
        <button class="add-btn" onclick="ac()">+ ì¡°ê±´ ì¶”ê°€</button>
      </div>
    </div>

    <!-- í”Œë˜ê·¸ -->
    <div class="addon">
      <div class="addon-head${fc?'':' closed'}" onclick="toggleAddon(this)">
        <span class="ah-label" style="color:var(--yellow)">âš‘ í”Œë˜ê·¸ (Flags)</span>
        <span class="ah-count" id="fc-lbl">${fc?fc+'ê°œ':'ì—†ìŒ'}</span>
        <span class="ah-arrow${fc?' open':''}">â–¶</span>
      </div>
      <div class="addon-body${fc?'':' hidden'}" id="flag-body">
        <div id="flag-list">${(nd.flags||[]).map((f,i)=>`
          <div class="frow">
            <input value="${ha(f.key)}" placeholder="í”Œë˜ê·¸ëª… ì˜ˆ: is_angry" oninput="uf(${i},'key',this.value)">
            <span style="color:var(--text3);font-size:11px;flex-shrink:0">=</span>
            <div class="toggle${f.value?' on':''}" onclick="tf(${i})" title="${f.value}"></div>
            <span style="font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--text3);width:28px;flex-shrink:0">${f.value?'true':'false'}</span>
            <button class="ic-btn" onclick="rf(${i})"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="12" y2="12"/><line x1="12" y1="4" x2="4" y2="12"/></svg></button>
          </div>`).join('')}</div>
        <button class="add-btn" onclick="af()">+ í”Œë˜ê·¸ ì¶”ê°€</button>
      </div>
    </div>

    <!-- íš¨ê³¼ìŒ -->
    <div class="addon">
      <div class="addon-head${sc?'':' closed'}" onclick="toggleAddon(this)">
        <span class="ah-label" style="color:var(--teal)">â™ª íš¨ê³¼ìŒ (Sounds)</span>
        <span class="ah-count" id="sc-lbl">${sc?sc+'ê°œ':'ì—†ìŒ'}</span>
        <span class="ah-arrow${sc?' open':''}">â–¶</span>
      </div>
      <div class="addon-body${sc?'':' hidden'}" id="sound-body">
        <div id="sound-list">${(nd.sounds||[]).map((s,i)=>`
          <div class="srow">
            <span style="color:var(--teal);font-size:13px;flex-shrink:0">â™ª</span>
            <input value="${ha(s.file)}" placeholder="íŒŒì¼ëª… ì˜ˆ: battle_start.ogg" oninput="us(${i},'file',this.value)" style="flex:1">
            <input value="${ha(s.volume!==undefined?s.volume:100)}" placeholder="100" style="max-width:38px;text-align:center" type="number" min="0" max="100" oninput="us(${i},'volume',parseInt(this.value)||100)" title="ë³¼ë¥¨(0-100)">
            <span style="color:var(--text3);font-size:9px;flex-shrink:0">%</span>
            <div class="toggle${s.loop?' on':''}" onclick="sloop(${i})" title="ë£¨í”„" style="flex-shrink:0"></div>
            <span style="font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--text3);flex-shrink:0">loop</span>
            <button class="ic-btn" onclick="rs(${i})"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="4" x2="12" y2="12"/><line x1="12" y1="4" x2="4" y2="12"/></svg></button>
          </div>`).join('')}</div>
        <button class="add-btn" onclick="as_()">+ íš¨ê³¼ìŒ ì¶”ê°€</button>
      </div>
    </div>

    <div class="idivider"></div>

    <!-- ì‹œìŠ¤í…œ -->
    <div class="field">
      <div class="flabel">ì´ˆìƒí™” íŒŒì¼ëª…</div>
      <input class="finput" value="${ha(nd.portrait)}" placeholder="ì˜ˆ: merlin_happy.png" oninput="sf('portrait',this.value);rc()">
    </div>
    <div class="field">
      <div class="flabel">í…ìŠ¤íŠ¸ ìŠ¤í”¼ë“œ</div>
      <div class="slider-row">
        <input type="range" min="1" max="100" value="${nd.textSpeed||30}"
          oninput="sf('textSpeed',parseInt(this.value));rc();document.getElementById('tsv').textContent=this.value">
        <span class="sval" id="tsv">${nd.textSpeed||30}</span>
      </div>
    </div>
    ${nd.type==='loop'?`
    <div class="field">
      <div class="flabel">ë£¨í”„ ëŒ€ìƒ ë…¸ë“œ</div>
      <select class="fselect" onchange="sf('loopTarget',this.value)">
        <option value="">â€” ì„ íƒ â€”</option>
        ${nodes.filter(n=>n.id!==selId).map(n=>`<option value="${n.id}"${nd.loopTarget===n.id?' selected':''}>${h(n.speaker||TM[n.type]?.label)} (${n.id})</option>`).join('')}
      </select>
    </div>`:''}
    <div class="field">
      <div class="flabel">ë©”ëª¨ (ë‚´ë¶€ìš©)</div>
      <textarea class="ftextarea" style="min-height:46px" placeholder="ì¶œë ¥ ì•ˆë¨" oninput="sf('note',this.value)">${h(nd.note||'')}</textarea>
    </div>
    <div style="display:flex;gap:7px">
      <button class="btn" onclick="duplicateSelected()">ë³µì œ</button>
      <button class="btn" style="color:var(--red);border-color:var(--red)" onclick="deleteSelected()">ì‚­ì œ</button>
    </div>`;
}

function assignGroup(gid){
  if(!selId)return;
  // remove from all groups
  groups.forEach(g=>{g.nodeIds=g.nodeIds.filter(id=>id!==selId);});
  groups=groups.filter(g=>g.nodeIds.length>0);
  if(gid){const g=groups.find(x=>x.id===gid);if(g)g.nodeIds.push(selId);}
  snapshot();renderAll();renderInsp();
}

// short helpers
function sf(k,v){const nd=nodes.find(n=>n.id===selId);if(nd)nd[k]=v;}
function rc(){
  const nd=nodes.find(n=>n.id===selId);
  const el=document.querySelector(`.node-card[data-id="${selId}"]`);
  if(nd&&el)syncCard(el,nd);renderEdges();renderMinimap();
}
function toggleAddon(head){const b=head.nextElementSibling,a=head.querySelector('.ah-arrow'),o=!b.classList.contains('hidden');b.classList.toggle('hidden',o);a.classList.toggle('open',!o);head.classList.toggle('closed',o);}

// conditions
function ac(){const nd=nodes.find(n=>n.id===selId);if(nd){nd.conditions.push({key:'',op:'==',value:''});snapshot();renderInsp();rc();}}
function rc2(i){const nd=nodes.find(n=>n.id===selId);if(nd){nd.conditions.splice(i,1);snapshot();renderInsp();rc();}}
function uc(i,k,v){const nd=nodes.find(n=>n.id===selId);if(nd){nd.conditions[i][k]=v;rc();const el=document.getElementById('cc-lbl');if(el)el.textContent=nd.conditions.length?nd.conditions.length+'ê°œ':'ì—†ìŒ';}}
// flags
function af(){const nd=nodes.find(n=>n.id===selId);if(nd){nd.flags.push({key:'',value:false});snapshot();renderInsp();rc();}}
function rf(i){const nd=nodes.find(n=>n.id===selId);if(nd){nd.flags.splice(i,1);snapshot();renderInsp();rc();}}
function uf(i,k,v){const nd=nodes.find(n=>n.id===selId);if(nd){nd.flags[i][k]=v;rc();const el=document.getElementById('fc-lbl');if(el)el.textContent=nd.flags.length?nd.flags.length+'ê°œ':'ì—†ìŒ';}}
function tf(i){const nd=nodes.find(n=>n.id===selId);if(nd){nd.flags[i].value=!nd.flags[i].value;snapshot();renderInsp();rc();}}
// sounds
function as_(){const nd=nodes.find(n=>n.id===selId);if(nd){if(!nd.sounds)nd.sounds=[];nd.sounds.push({file:'',volume:100,loop:false});snapshot();renderInsp();rc();}}
function rs(i){const nd=nodes.find(n=>n.id===selId);if(nd){nd.sounds.splice(i,1);snapshot();renderInsp();rc();}}
function us(i,k,v){const nd=nodes.find(n=>n.id===selId);if(nd){if(!nd.sounds)nd.sounds=[];nd.sounds[i][k]=v;rc();const el=document.getElementById('sc-lbl');if(el)el.textContent=nd.sounds.length?nd.sounds.length+'ê°œ':'ì—†ìŒ';}}
function sloop(i){const nd=nodes.find(n=>n.id===selId);if(nd){nd.sounds[i].loop=!nd.sounds[i].loop;snapshot();renderInsp();rc();}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONNECTING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startConnect(id){
  connecting=(id!==undefined?id:selId); if(!connecting) return;
  document.getElementById('canvas-wrap').style.cursor='crosshair';
  toast('ì—°ê²°í•  ë…¸ë“œë¥¼ í´ë¦­í•˜ì„¸ìš”. ESCë¡œ ì·¨ì†Œ.','');
}
function finishConnect(toId){
  if(!connecting||connecting===toId){cancelConn();return;}
  if(!edges.find(e=>e.from===connecting&&e.to===toId)){
    edges.push({id:'E'+(nxtId++),from:connecting,to:toId,label:''});
    snapshot(); toast('ì—°ê²° ì™„ë£Œ!','ok');
  }
  cancelConn(); renderAll();
}
function cancelConn(){connecting=null;connPrev=null;document.getElementById('canvas-wrap').style.cursor='';renderEdges();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NODE DRAG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nodeDragStart(e,id){
  if(connecting)return; e.stopPropagation();
  const nd=nodes.find(n=>n.id===id); if(!nd) return;
  const r=cw.getBoundingClientRect();
  const cx=(e.clientX-r.left-vp.x)/vp.s, cy=(e.clientY-r.top-vp.y)/vp.s;

  if(multiSel.size>1 && multiSel.has(id)){
    // multi-drag: store start positions of all selected nodes
    const starts={};
    multiSel.forEach(sid=>{const snd=nodes.find(n=>n.id===sid);if(snd)starts[sid]={x:snd.x,y:snd.y};});
    dragging={multi:true,starts,ox:cx,oy:cy};
  } else {
    selId=id;multiSel.clear();updateMultiBar();
    dragging={id,ox:cx-nd.x,oy:cy-nd.y};
    document.querySelectorAll('.node-card').forEach(el=>el.classList.toggle('sel',el.dataset.id===id));
    renderInsp();updateSt();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RUBBER BAND â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rb=document.getElementById('rubber-band');
function startRubberBand(e){
  const r=cw.getBoundingClientRect();
  rubberBand={sx:e.clientX-r.left,sy:e.clientY-r.top,ex:e.clientX-r.left,ey:e.clientY-r.top};
  rb.style.display='block';
  updateRubberBand();
}
function updateRubberBand(){
  if(!rubberBand)return;
  const {sx,sy,ex,ey}=rubberBand;
  rb.style.left=Math.min(sx,ex)+'px';rb.style.top=Math.min(sy,ey)+'px';
  rb.style.width=Math.abs(ex-sx)+'px';rb.style.height=Math.abs(ey-sy)+'px';
}
function finishRubberBand(){
  if(!rubberBand){return;}
  rb.style.display='none';
  const {sx,sy,ex,ey}=rubberBand;
  const x1=Math.min(sx,ex),y1=Math.min(sy,ey),x2=Math.max(sx,ex),y2=Math.max(sy,ey);
  if(Math.abs(x2-x1)<4&&Math.abs(y2-y1)<4){rubberBand=null;return;}
  // convert to canvas coords
  const cx1=(x1-vp.x)/vp.s,cy1=(y1-vp.y)/vp.s,cx2=(x2-vp.x)/vp.s,cy2=(y2-vp.y)/vp.s;
  multiSel.clear();selId=null;
  nodes.forEach(nd=>{
    if(nd.x+230>=cx1&&nd.x<=cx2&&nd.y+120>=cy1&&nd.y<=cy2) multiSel.add(nd.id);
  });
  rubberBand=null;
  updateMultiBar();renderNodes();renderList();renderInsp();updateSt();
  if(multiSel.size) toast(multiSel.size+'ê°œ ì„ íƒë¨','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CANVAS EVENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cw=document.getElementById('canvas-wrap');
cw.addEventListener('mousedown',e=>{
  if(e.target!==cw&&!e.target.closest('#esvg'))return;
  if(connecting){cancelConn();return;}
  if(e.button===0){
    if(e.shiftKey){
      // Shift+drag â†’ rubber band multi-select
      startRubberBand(e);
    } else {
      // normal drag â†’ pan
      panning={mx:e.clientX,my:e.clientY,vx:vp.x,vy:vp.y};
    }
  }
});
window.addEventListener('mousemove',e=>{
  if(dragging){
    const r=cw.getBoundingClientRect();
    if(dragging.multi){
      const dx=(e.clientX-r.left-vp.x)/vp.s - dragging.ox;
      const dy=(e.clientY-r.top-vp.y)/vp.s  - dragging.oy;
      multiSel.forEach(sid=>{
        const snd=nodes.find(n=>n.id===sid); if(!snd)return;
        snd.x=Math.round(dragging.starts[sid].x+dx);
        snd.y=Math.round(dragging.starts[sid].y+dy);
        const el=document.querySelector(`.node-card[data-id="${sid}"]`);
        if(el){el.style.left=snd.x+'px';el.style.top=snd.y+'px';}
      });
    } else {
      const nd=nodes.find(n=>n.id===dragging.id); if(!nd) return;
      nd.x=Math.round((e.clientX-r.left-vp.x)/vp.s-dragging.ox);
      nd.y=Math.round((e.clientY-r.top-vp.y)/vp.s-dragging.oy);
      const el=document.querySelector(`.node-card[data-id="${dragging.id}"]`);
      if(el){el.style.left=nd.x+'px';el.style.top=nd.y+'px';}
    }
    renderEdges();renderGroups();renderMinimap();return;
  }
  if(rubberBand){
    const r=cw.getBoundingClientRect();
    rubberBand.ex=e.clientX-r.left;rubberBand.ey=e.clientY-r.top;
    updateRubberBand();
    return;
  }
  if(panning){vp.x=panning.vx+(e.clientX-panning.mx);vp.y=panning.vy+(e.clientY-panning.my);applyVP();renderMinimap();}
  if(connecting){
    const r=cw.getBoundingClientRect();
    connPrev={x:(e.clientX-r.left-vp.x)/vp.s,y:(e.clientY-r.top-vp.y)/vp.s};
    renderEdges();
  }
});
window.addEventListener('mouseup',e=>{
  if(dragging){snapshot();renderAll();}
  else if(rubberBand){finishRubberBand();}
  dragging=null;panning=null;
});
cw.addEventListener('wheel',e=>{
  e.preventDefault();
  const d=e.deltaY>0?.88:1.13;
  const r=cw.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;
  vp.x=mx-(mx-vp.x)*d;vp.y=my-(my-vp.y)*d;
  vp.s=Math.max(.15,Math.min(3,vp.s*d));
  applyVP();renderMinimap();
},{passive:false});

function doZoom(d){const r=cw.getBoundingClientRect(),mx=r.width/2,my=r.height/2;vp.x=mx-(mx-vp.x)*d;vp.y=my-(my-vp.y)*d;vp.s=Math.max(.15,Math.min(3,vp.s*d));applyVP();renderMinimap();}
function resetView(){vp={x:60,y:60,s:1};applyVP();renderMinimap();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CTX MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCtx(x,y,hasNode){
  const m=document.getElementById('ctx');
  document.getElementById('ci-child').style.display=hasNode&&!multiSel.size?'':'none';
  document.getElementById('ci-conn').style.display=hasNode&&!multiSel.size?'':'none';
  m.style.left=x+'px';m.style.top=y+'px';m.classList.add('show');
}
function canvasCtx(e){
  e.preventDefault();
  if(e.target===cw||e.target.closest('#esvg')){
    selId=null;multiSel.clear();updateMultiBar();renderAll();renderInsp();
    document.getElementById('ci-ungroup').style.display='none';
    showCtx(e.clientX,e.clientY,false);
  }
}
document.addEventListener('click',()=>document.getElementById('ctx').classList.remove('show'));
function ctxChild(){const p=selId;addNode('dialog');if(p&&nodes.length){edges.push({id:'E'+(nxtId++),from:p,to:nodes[nodes.length-1].id,label:''});snapshot();renderAll();}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DELETE / DUPE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deleteSelected(){
  const ids = multiSel.size>0 ? [...multiSel] : (selId ? [selId] : null);
  if(!ids || ids.length===0) return;
  nodes  = nodes.filter(n => !ids.includes(n.id));
  edges  = edges.filter(e => !ids.includes(e.from) && !ids.includes(e.to));
  groups.forEach(g => { g.nodeIds = g.nodeIds.filter(id => !ids.includes(id)); });
  groups = groups.filter(g => g.nodeIds.length > 0);
  selId  = null;
  multiSel.clear();
  updateMultiBar();
  snapshot(); renderAll(); renderInsp(); toast('ì‚­ì œë¨ (Ctrl+Zë¡œ ë³µêµ¬)','err');
}
function duplicateSelected(){
  const ids=multiSel.size>0?[...multiSel]:(selId?[selId]:null);
  if(!ids)return;
  const map={};
  ids.forEach(id=>{
    const nd=nodes.find(n=>n.id===id);if(!nd)return;
    const c=JSON.parse(JSON.stringify(nd));
    map[id]=c.id='N'+(nxtId++);
    c.x+=50;c.y+=50;nodes.push(c);
  });
  snapshot();renderAll();
  if(ids.length===1)selectNode(map[ids[0]]);
  toast('ë³µì œë¨','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• KEYBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  const tag=document.activeElement.tagName;
  const inInput=['INPUT','TEXTAREA','SELECT'].includes(tag);
  if(e.key==='Escape'){cancelConn();clearMultiSel();}
  if(e.key==='Delete'&&!inInput){deleteSelected();}
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!inInput){e.preventDefault();undo();}
  if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.shiftKey&&e.key==='z'))&&!inInput){e.preventDefault();redo();}
  if((e.ctrlKey||e.metaKey)&&e.key==='a'&&!inInput){
    e.preventDefault();
    nodes.forEach(n=>multiSel.add(n.id));selId=null;
    updateMultiBar();renderNodes();renderList();renderInsp();updateSt();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NODE LIST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ê·¸ë£¹ ì ‘í˜ ìƒíƒœë¥¼ ì˜êµ¬ ë³´ì¡´ (ë Œë”ë§ í›„ì—ë„ ìœ ì§€)
const groupCollapsed = new Map(); // gid â†’ true(ì ‘í˜)

function renderList(){
  const list=document.getElementById('node-list');
  if(!nodes.length){list.innerHTML='<div style="color:var(--text3);font-size:11px;text-align:center;padding:14px">ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤</div>';return;}

  const q=searchQuery;
  let html='';

  // Group section
  const groupedIds=new Set(groups.flatMap(g=>g.nodeIds));
  groups.forEach(g=>{
    const allMembers=nodes.filter(n=>g.nodeIds.includes(n.id));
    const visibleMembers=allMembers.filter(n=>!q||nodeMatchesSearch(n));
    if(q&&!visibleMembers.length)return;
    const collapsed=groupCollapsed.get(g.id)===true;
    html+=`<div class="nli-group-header" onclick="toggleListGroup('${g.id}',this)">
      <span class="gh-arrow${collapsed?'':' open'}">â–¶</span>
      <span style="color:${g.color}">â–£</span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${h(g.name)}</span>
      <span style="font-size:9px;color:var(--text3)">${allMembers.length}</span>
    </div>
    <div id="lg-${g.id}" style="display:${collapsed?'none':''}">`;
    allMembers.forEach(nd=>{
      if(q&&!nodeMatchesSearch(nd))return;
      const isSel=nd.id===selId,isMulti=multiSel.has(nd.id);
      html+=`<div class="nli${isSel?' sel':''}${isMulti?' multi-sel':''}" style="padding-left:18px" onclick="selectNode('${nd.id}');scrollToNode('${nd.id}')">
        <div class="nli-dot" style="background:${TM[nd.type]?.col||'#888'}"></div>
        <span class="nli-text">${q?highlight(nd.speaker||TM[nd.type]?.label||nd.type,q):h(nd.speaker||TM[nd.type]?.label||nd.type)}</span>
        <span class="nli-id">${nd.id}</span>
      </div>`;
    });
    html+='</div>';
  });

  // Ungrouped
  const ungrouped=nodes.filter(n=>!groupedIds.has(n.id)&&(!q||nodeMatchesSearch(n)));
  ungrouped.forEach(nd=>{
    const isSel=nd.id===selId,isMulti=multiSel.has(nd.id);
    html+=`<div class="nli${isSel?' sel':''}${isMulti?' multi-sel':''}" onclick="selectNode('${nd.id}');scrollToNode('${nd.id}')">
      <div class="nli-dot" style="background:${TM[nd.type]?.col||'#888'}"></div>
      <span class="nli-text">${q?highlight(nd.speaker||TM[nd.type]?.label||nd.type,q):h(nd.speaker||TM[nd.type]?.label||nd.type)}</span>
      <span class="nli-id">${nd.id}</span>
    </div>`;
  });

  if(!html)html='<div style="color:var(--text3);font-size:11px;text-align:center;padding:14px">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div>';
  list.innerHTML=html;
}
function toggleListGroup(gid, hdr){
  const collapsed = groupCollapsed.get(gid)===true;
  groupCollapsed.set(gid, !collapsed);
  const el=document.getElementById('lg-'+gid);
  const arr=hdr.querySelector('.gh-arrow');
  if(el) el.style.display=collapsed?'':'none';
  if(arr) arr.classList.toggle('open', collapsed);
}
function highlight(str,q){
  const s=h(str),ql=q.toLowerCase(),sl=s.toLowerCase();
  const i=sl.indexOf(ql);
  if(i<0)return s;
  return s.slice(0,i)+`<mark style="background:rgba(240,201,77,.35);color:var(--yellow);border-radius:2px">${s.slice(i,i+ql.length)}</mark>`+s.slice(i+ql.length);
}
function scrollToNode(id){
  const nd=nodes.find(n=>n.id===id);if(!nd)return;
  const r=cw.getBoundingClientRect();
  vp.x=r.width/2-nd.x*vp.s-115*vp.s;vp.y=r.height/2-nd.y*vp.s-60*vp.s;
  applyVP();renderMinimap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AUTO LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoLayout(){
  if(!nodes.length)return;
  const cm={},hp=new Set();
  nodes.forEach(n=>{cm[n.id]=[];});
  edges.forEach(e=>{if(cm[e.from])cm[e.from].push(e.to);hp.add(e.to);});
  const roots=nodes.filter(n=>!hp.has(n.id));
  const lm={},vis=new Set();
  function assign(id,d){if(vis.has(id))return;vis.add(id);if(!lm[d])lm[d]=[];lm[d].push(id);(cm[id]||[]).forEach(c=>assign(c,d+1));}
  roots.forEach(r=>assign(r.id,0));
  nodes.forEach(n=>{if(!vis.has(n.id))assign(n.id,Object.keys(lm).length);});
  Object.entries(lm).forEach(([d,ids])=>{
    const tot=ids.length*280;
    ids.forEach((id,i)=>{const nd=nodes.find(n=>n.id===id);if(nd){nd.x=i*280-tot/2+500;nd.y=parseInt(d)*160+60;}});
  });
  snapshot();renderAll();toast('ìë™ ì •ë ¬ ì™„ë£Œ','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MINIMAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMinimap(){
  const c=document.getElementById('minimap'),ctx=c.getContext('2d');
  ctx.clearRect(0,0,150,90);ctx.fillStyle='#12151d';ctx.fillRect(0,0,150,90);
  if(!nodes.length)return;
  const xs=nodes.map(n=>n.x),ys=nodes.map(n=>n.y);
  const mnX=Math.min(...xs)-10,mnY=Math.min(...ys)-10,mxX=Math.max(...xs)+240,mxY=Math.max(...ys)+130;
  const sc=Math.min(140/(mxX-mnX||1),80/(mxY-mnY||1));
  edges.forEach(ed=>{
    const f=nodes.find(n=>n.id===ed.from),t=nodes.find(n=>n.id===ed.to);if(!f||!t)return;
    ctx.strokeStyle='#272c3e';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo((f.x+115-mnX)*sc+5,(f.y+60-mnY)*sc+5);
    ctx.lineTo((t.x+115-mnX)*sc+5,(t.y+60-mnY)*sc+5);ctx.stroke();
  });
  nodes.forEach(nd=>{
    const isMulti=multiSel.has(nd.id);
    ctx.fillStyle=isMulti?'#f0934d':(nd.id===selId?'#4d8fff':(TM[nd.type]?.col||'#888'));
    ctx.globalAlpha=nd.id===selId||isMulti?1:.7;
    ctx.fillRect((nd.x-mnX)*sc+5,(nd.y-mnY)*sc+5,Math.max(8,230*sc),Math.max(4,120*sc));
  });
  ctx.globalAlpha=1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSt(){
  document.getElementById('st-n').textContent=nodes.length;
  document.getElementById('st-e').textContent=edges.length;
  const ms=multiSel.size;
  document.getElementById('st-s').textContent=ms>1?ms+'ê°œ ì„ íƒ':(selId||(connecting?'ì—°ê²° ì¤‘':'â€”'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PALETTE DRAG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function palDrag(e,type){palType=type;e.dataTransfer.effectAllowed='copy';}
function canvasDrop(e){
  e.preventDefault();if(!palType)return;
  const r=cw.getBoundingClientRect(),x=(e.clientX-r.left-vp.x)/vp.s-115,y=(e.clientY-r.top-vp.y)/vp.s-60;
  const nd=mkNode(palType,x,y);nodes.push(nd);palType=null;snapshot();renderAll();selectNode(nd.id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JSON â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getProj(){return{projectName:document.getElementById('proj-name').value,version:'3.0',nodes,edges,groups};}
function saveJSON(){
  const d=getProj(),a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));
  a.download=(d.projectName||'dialogue')+'.json';a.click();
  toast('ì €ì¥ ì™„ë£Œ!','ok');closeModal('json-modal');
}
function loadJSON(ev){
  const f=ev.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const d=JSON.parse(e.target.result);
      nodes=d.nodes||[];edges=d.edges||[];groups=d.groups||[];
      if(d.projectName)document.getElementById('proj-name').value=d.projectName;
      const mx=Math.max(...[...nodes,...edges,...groups].map(x=>parseInt((x.id||'').replace(/\D/g,''))||0),0);
      nxtId=mx+1;selId=null;multiSel.clear();
      snapshot();renderAll();renderInsp();toast('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!','ok');
    }catch(err){toast('íŒŒì¼ ì˜¤ë¥˜: '+err.message,'err');}
  };
  r.readAsText(f);ev.target.value='';
}
function showJson(){document.getElementById('json-pre').textContent=JSON.stringify(getProj(),null,2);openModal('json-modal');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('show');}));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tt;
function toast(msg,type){const el=document.getElementById('toast');el.textContent=msg;el.className='show'+(type?' '+type:'');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('show'),2400);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function h(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function ha(s){if(!s)return'';return String(s).replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL RESIZE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  function makeResizer(resizerId, targetId, side){
    const resizer = document.getElementById(resizerId);
    const target  = document.getElementById(targetId);
    let startX, startW;
    resizer.addEventListener('mousedown', e=>{
      e.preventDefault();
      startX = e.clientX; startW = target.getBoundingClientRect().width;
      resizer.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      function onMove(e){
        const delta = e.clientX - startX;
        const newW  = side === 'right'
          ? Math.max(140, Math.min(520, startW + delta))
          : Math.max(240, Math.min(600, startW - delta));
        target.style.width = newW + 'px';
      }
      function onUp(){
        resizer.classList.remove('dragging');
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
        window.removeEventListener('mousemove', onMove);
        window.removeEventListener('mouseup', onUp);
      }
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    });
  }
  makeResizer('sidebar-resizer',   'sidebar',   'right');
  makeResizer('inspector-resizer', 'inspector', 'left');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
snapshot(); // initial empty snapshot
renderAll();
updateUndoUI();
</script>
</body>
</html>
